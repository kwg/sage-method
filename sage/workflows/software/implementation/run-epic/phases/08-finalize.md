# Phase 08: Finalize Epic

```xml
<phase id="08-finalize" name="Finalize Epic">

  <purpose>
    Complete epic execution:
    - Generate metrics summary
    - Generate learning summary
    - Create PR (or prepare for manual merge)
    - Human checkpoint before merge
  </purpose>

  <input>
    {{state}} with:
    - epic_id: epic identifier
    - epic_branch: current git branch
    - completed_stories: list of completed story IDs
    - failed_stories: list of failed stories
    - metrics: all collected metrics
    - learning_records: failure patterns
  </input>

  <preconditions>
    - Epic QA complete (passed or with known issues)
    - On epic branch
  </preconditions>

  <execution>

    <step n="1" name="calculate-summary">
      <action>Calculate final metrics:
        - total_duration: end_time - start_time
        - stories_completed: length(completed_stories)
        - stories_failed: length(failed_stories)
        - stories_skipped: length(skipped_stories)
        - total_chunks: sum of chunks_planned across stories
        - avg_chunk_duration: average implementation time
        - tdd_compliance_rate: tests_written_first / (tests_written_first + tests_written_after)
        - learning_patterns_identified: unique patterns from learning_records
      </action>

      <action>Set metrics.end_time = {{current_iso_timestamp}}</action>
    </step>

    <step n="2" name="generate-metrics-file">
      <action>Write metrics to: docs/sprint-artifacts/epic-{{epic_id}}-metrics.json</action>

      <action>git add docs/sprint-artifacts/epic-{{epic_id}}-metrics.json</action>
      <action>git commit -m "{{epic_id}}: add epic metrics"</action>

      <output>üìä Metrics saved to docs/sprint-artifacts/epic-{{epic_id}}-metrics.json</output>
    </step>

    <step n="3" name="aggregate-learnings">
      <action>
        learning_recorder:
          action: aggregate
          epic_id: {{epic_id}}
      </action>

      <action>Generate learning summary:
        - Total failures: {{learning_records.length}}
        - By category: {{categorized_failures}}
        - Top patterns: {{top_patterns}}
        - Prevention rules: {{prevention_rules}}
        - Recommendations: {{recommendations}}
      </action>
    </step>

    <step n="4" name="generate-learning-file">
      <action>Write learning summary to: docs/sprint-artifacts/learning/epic-{{epic_id}}-learnings.md</action>

      <action>git add docs/sprint-artifacts/learning/</action>
      <action>git commit -m "{{epic_id}}: add learning summary"</action>

      <output>üìö Learning summary saved to docs/sprint-artifacts/learning/</output>
    </step>

    <step n="5" name="push-branch">
      <output>üì§ Pushing epic branch to remote...</output>

      <action>git push -u origin {{epic_branch}}</action>

      <check if="push fails">
        <error>Failed to push branch. Check remote access.</error>
        <action>Output git error</action>
        <action>Ask user to resolve manually</action>
      </check>

      <output>‚úÖ Pushed {{epic_branch}} to origin</output>
    </step>

    <step n="6" name="create-pr">
      <output>üìù Creating Pull Request...</output>

      <action>Generate PR body from metrics and learnings</action>

      <action>Create PR using gh:
        gh pr create \
          --base dev \
          --head {{epic_branch}} \
          --title "{{epic_id}}: {{epic_title}}" \
          --body "{{pr_body}}"
      </action>

      <pr-body-template>
## Epic Summary

{{epic_title}}

## Stories Completed

{{for story in completed_stories}}
- ‚úÖ {{story}}
{{endfor}}

{{if failed_stories.length > 0}}
## Stories Failed

{{for story in failed_stories}}
- ‚ùå {{story.story_id}}: {{story.reason}}
{{endfor}}
{{endif}}

## Metrics

| Metric | Value |
|--------|-------|
| Total Duration | {{metrics.summary.total_duration}} |
| Stories Completed | {{metrics.summary.completed_stories}}/{{metrics.summary.total_stories}} |
| TDD Compliance | {{metrics.summary.tdd_compliance_rate | percent}} |
| Test Attempts (avg) | {{metrics.summary.avg_test_attempts}} |
| Review Iterations (avg) | {{metrics.summary.avg_review_iterations}} |

## Learning Patterns Identified

{{for pattern in top_patterns}}
- **{{pattern.pattern}}** ({{pattern.occurrences}}x) - {{pattern.prevention_rule}}
{{endfor}}

## QA Results

- Smoke Tests: {{metrics.summary.smoke_tests_passed ? "‚úÖ PASSED" : "‚ùå FAILED"}}
- Regression Tests: {{metrics.summary.regression_tests_passed ? "‚úÖ PASSED" : "‚ö†Ô∏è SKIPPED/FAILED"}}

---

ü§ñ Generated by SAGE Software Module v1.0
      </pr-body-template>

      <output>‚úÖ PR created: {{pr_url}}</output>
    </step>

    <step n="7" name="human-checkpoint">
      <output>
‚è∏Ô∏è **HUMAN CHECKPOINT**

The epic is complete and a PR has been created.

**Summary:**
- Stories: {{completed_stories.length}} completed, {{failed_stories.length}} failed
- TDD Compliance: {{tdd_compliance_rate | percent}}
- QA Status: {{qa_status}}

**PR:** {{pr_url}}

**Next Steps:**
1. Review the PR
2. Run any additional manual testing
3. Approve and merge when ready

The orchestrator will now exit. Resume with `*run-epic {{epic_id}}` if needed.
      </output>
    </step>

  </execution>

  <output>
üéâ **Epic Execution Complete!**

Epic: {{epic_id}} - {{epic_title}}
Branch: {{epic_branch}}
PR: {{pr_url}}

**Final Stats:**
- Duration: {{total_duration}}
- Stories: {{completed_stories.length}}/{{story_queue.length}} completed
- TDD Compliance: {{tdd_compliance_rate | percent}}
- Patterns Learned: {{learning_patterns_identified}}

Awaiting human review and merge.
  </output>

  <return>
    {
      "next_phase": "done",
      "state_updates": {
        "metrics": {{final_metrics}},
        "pr_url": "{{pr_url}}"
      },
      "output": "{{output_text}}"
    }
  </return>

</phase>
```
